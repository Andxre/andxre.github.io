{{- $level := .level | default 0 -}}
{{- if eq $level 0 -}}
    <nav class="menu">
        {{- range $item := .collection -}}
            <section class="menu__section">
                <h2 class="menu__section-title">{{ safeHTML $item.title }}</h2>
                {{- if $item.entries -}}
                    {{ partial "menu_item.html" (dict "context" $.context "collection" $item.entries "level" (add $level 1)) }}
                {{- end -}}
                {{- if $item.post_list -}}
                    <div class="menu__posts">
                        {{ partial "post_list.html" (dict "context" $.context "section" $item.post_list.section "limit" $item.post_list.limit "show_more" $item.post_list.show_more "show_more_text" $item.post_list.show_more_text "show_more_url" $item.post_list.show_more_url) }}
                    </div>
                {{- end -}}
            </section>
        {{- end -}}
    </nav>
{{- else -}}
    <ul class="{{ if eq $level 1 }}menu__links{{ else }}menu__links menu__links--nested{{ end }}">
        {{- range $child := .collection -}}
            <li class="menu__link-item">
                {{- if $child.url -}}
                    {{ $url := $child.url }}
                    {{ $isExternal := or (hasPrefix $url "http") (hasPrefix $url "mailto:") (hasPrefix $url "tel:") (hasPrefix $url "#") }}
                    {{ $href := cond $isExternal $url ($url | relURL) }}
                    <a class="menu__link" href="{{ $href }}">{{ safeHTML $child.title }}</a>
                {{- else -}}
                    <span class="menu__link menu__link--label">{{ safeHTML $child.title }}</span>
                {{- end -}}

                {{- if $child.entries -}}
                    {{ partial "menu_item.html" (dict "context" $.context "collection" $child.entries "level" (add $level 1)) }}
                {{- end -}}

                {{- if $child.post_list -}}
                    <div class="menu__posts">
                        {{ partial "post_list.html" (dict "context" $.context "section" $child.post_list.section "limit" $child.post_list.limit "show_more" $child.post_list.show_more "show_more_text" $child.post_list.show_more_text "show_more_url" $child.post_list.show_more_url) }}
                    </div>
                {{- end -}}
            </li>
        {{- end -}}
    </ul>
{{- end -}}
